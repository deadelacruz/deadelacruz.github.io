name: Update News Every 12 Hours

on:
  schedule:
    # Run every 12 hours at 00:00 and 12:00 UTC (aligns with NewsAPI 12-hour reset cycle)
    # Philippine Time (PHT, UTC+8): 8:00 AM and 8:00 PM daily
    # NewsAPI Developer plan: 50 requests per 12 hours, resets every 12 hours
    - cron: '0 0,12 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  update-news:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # Required to push changes back to repository
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Update news
        env:
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
        run: |
          echo "Checking NEWSAPI_KEY..."
          if [ -z "$NEWSAPI_KEY" ]; then
            echo "ERROR: NEWSAPI_KEY secret is not set in repository secrets!"
            echo "Please go to: Settings → Secrets and variables → Actions → Add secret"
            exit 1
          else
            echo "NEWSAPI_KEY is set (length: ${#NEWSAPI_KEY} characters)"
          fi
          python update_news.py

      - name: Check for changes
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain _data/news/)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push changes
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          # Configure pull strategy to use merge (not rebase) to avoid divergent branch errors
          git config pull.rebase false
          git config pull.ff false
          
          # Fetch latest changes from remote
          echo "Fetching latest changes from remote..."
          git fetch origin master
          
          # Stash our local changes temporarily to allow clean merge
          echo "Stashing local news changes..."
          git stash push -m "Temporary stash for news updates" _data/news/
          
          # Check if remote is ahead of local
          REMOTE_AHEAD=$(git rev-list HEAD..origin/master --count 2>/dev/null || echo "0")
          
          if [ "$REMOTE_AHEAD" -gt 0 ]; then
            echo "Remote is ahead by $REMOTE_AHEAD commits. Merging remote changes..."
            # Merge remote changes first
            if git merge origin/master --no-edit; then
              echo "Merge completed successfully"
            else
              echo "Merge had conflicts, aborting merge and keeping remote version..."
              git merge --abort || true
              # If merge fails, we'll still apply our stashed changes on top
            fi
          else
            echo "Local branch is up to date with remote"
          fi
          
          # Restore our stashed changes (our news updates take priority)
          echo "Restoring stashed news changes..."
          if ! git stash pop; then
            echo "Stash pop had conflicts, keeping our stashed version (new news updates)..."
            # If there are conflicts, keep our stashed version (the new news updates)
            # In stash pop context: --theirs = stashed changes (our new updates)
            git checkout --theirs _data/news/ 2>/dev/null || true
            git add _data/news/
          fi
          
          # Stage our news file changes
          echo "Staging news file changes..."
          git add _data/news/
          
          # Check if we have changes to commit
          if ! git diff --cached --quiet; then
            echo "Committing local changes..."
            git commit -m "Auto-update news: $(date +'%Y-%m-%d %H:%M:%S')"
          else
            echo "No changes to commit after merge"
          fi
          
          # Push to remote
          echo "Pushing to remote..."
          git push origin master

