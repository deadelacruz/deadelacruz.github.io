{% assign maxRelated = 4 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}

{% for post in site.posts %}
  {% if post.url != page.url %}
    {% assign sameTagCount = 0 %}
    {% assign commonTags = '' %}
    {% for tag in post.tags %}
      {% if page.tags contains tag %}
        {% assign sameTagCount = sameTagCount | plus: 1 %}
      {% endif %}
    {% endfor %}
    {% if sameTagCount >= minCommonTags %}
      {% assign relatedPosts = relatedPosts | append: post.url | append: '|' %}
      {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
      {% if maxRelatedCounter >= maxRelated %}
        {% break %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endfor %}

{% if maxRelatedCounter > 0 %}
<div class="card mt-4">
  <div class="card-header">
    <h3>Related Articles</h3>
  </div>
  <div class="card-body">
    <ul class="related-articles-list">
      {% assign relatedPostsArray = relatedPosts | split: '|' %}
      {% for postUrl in relatedPostsArray limit: maxRelated %}
        {% for post in site.posts %}
          {% if post.url == postUrl %}
            <li>
              <a href="{{ post.url | relative_url }}">
                <h4>{{ post.title }}</h4>
                <p class="text-muted">{{ post.summary | truncate: 100 }}</p>
              </a>
            </li>
            {% break %}
          {% endif %}
        {% endfor %}
      {% endfor %}
    </ul>
  </div>
</div>
{% endif %}

<style>
.related-articles-list {
  list-style: none;
  padding: 0;
}
.related-articles-list li {
  margin-bottom: 20px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--card-background-color);
}
.related-articles-list li:last-child {
  border-bottom: none;
  margin-bottom: 0;
  padding-bottom: 0;
}
.related-articles-list a {
  text-decoration: none;
  color: var(--main-text-color);
}
.related-articles-list a:hover {
  color: var(--link-color);
}
.related-articles-list h4 {
  margin-bottom: 8px;
  font-size: 1.1em;
}
</style>

