{% comment %} Extract topic from page permalink {% endcomment %}
{% assign topic = page.permalink | remove: '/' | replace: '-', '_' %}
{% assign news_data = null %}

{% comment %} Map topic to corresponding data file {% endcomment %}
{% case topic %}
  {% when 'deep_learning' %}
    {% assign news_data = site.data.news.deep-learning %}
  {% when 'machine_learning' %}
    {% assign news_data = site.data.news.machine-learning %}
  {% when 'artificial_intelligence' %}
    {% assign news_data = site.data.news.artificial-intelligence %}
  {% when 'technology' %}
    {% assign news_data = site.data.news.technology %}
  {% when 'science' %}
    {% assign news_data = site.data.news.science %}
  {% when 'business' %}
    {% assign news_data = site.data.news.business %}
  {% when 'health' %}
    {% assign news_data = site.data.news.health %}
{% endcase %}

{% comment %} Get UI configuration {% endcomment %}
{% assign ui_config = site.data.news_config.ui %}
{% assign articles_per_page = ui_config.articles_per_page | default: 20 %}
{% assign enable_pagination = ui_config.enable_pagination | default: true %}
{% assign show_all_option = ui_config.show_all_option | default: true %}

{% if news_data and news_data.news_items %}
  {% assign sorted_news = news_data.news_items | sort: "date" | reverse %}
  {% assign total_articles = sorted_news | size %}
  
  <div class="news-container-wrapper">
    {% comment %} Display controls: Show All button (if enabled) {% endcomment %}
    {% if enable_pagination and show_all_option and total_articles > articles_per_page %}
      <div style="margin-bottom: 15px; text-align: right;">
        <button id="show-all-btn" style="padding: 8px 16px; background-color: var(--link-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
          Show All Articles ({{ total_articles }})
        </button>
        <button id="show-paginated-btn" style="display: none; padding: 8px 16px; background-color: var(--link-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; margin-left: 10px;">
          Show Paginated ({{ articles_per_page }} per page)
        </button>
      </div>
    {% endif %}
    
    {% comment %} News items container {% endcomment %}
    <div id="news-container" class="news-container">
      {% for item in sorted_news %}
        <div class="news-item" data-article-index="{{ forloop.index0 }}" style="margin-bottom: 20px; padding: 15px; background-color: var(--card-background-color); border-radius: 8px; border-left: 4px solid var(--link-color);">
          <h4 style="margin-top: 0; margin-bottom: 10px;">
            <strong>{{ item.title | escape }}</strong>
          </h4>
          <p style="margin-bottom: 10px; color: var(--main-text-color);">
            {{ item.description | escape }}
          </p>
          <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" style="color: var(--link-color); text-decoration: none;">
            Read more →
          </a>
          {% if item.source %}
            <span style="color: var(--main-text-color); opacity: 0.7; font-size: 0.9em; margin-left: 10px;">
              | {{ item.source | escape }}
            </span>
          {% endif %}
          {% if item.date %}
            <span style="color: var(--main-text-color); opacity: 0.7; font-size: 0.9em; margin-left: 10px;">
              {% comment %} Format date - Jekyll date filter handles YYYY-MM-DD format {% endcomment %}
              {% assign formatted_date = item.date | date: "%B %d, %Y" %}
              {% if formatted_date != item.date %}
                ({{ formatted_date }})
              {% else %}
                ({{ item.date }})
              {% endif %}
            </span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    
    {% comment %} Pagination controls {% endcomment %}
    {% if enable_pagination and total_articles > articles_per_page %}
      <div id="pagination-controls" style="margin-top: 30px; text-align: center;">
        <div style="margin-bottom: 15px; color: var(--main-text-color);">
          <span id="pagination-info">Showing <span id="showing-from">1</span>-<span id="showing-to">{{ articles_per_page }}</span> of {{ total_articles }} articles</span>
        </div>
        <div style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
          <button id="prev-btn" style="padding: 8px 16px; background-color: var(--link-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;" disabled>
            ← Previous
          </button>
          <div id="page-numbers" style="display: flex; gap: 5px; flex-wrap: wrap; justify-content: center;">
            {% comment %} Page numbers will be generated by JavaScript {% endcomment %}
          </div>
          <button id="next-btn" style="padding: 8px 16px; background-color: var(--link-color); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em;">
            Next →
          </button>
        </div>
      </div>
    {% endif %}
    
    <p style="margin-top: 20px; font-style: italic; color: var(--main-text-color); opacity: 0.7;">
      <em>Last updated: <span id="philippines-time">Loading...</span></em>
    </p>
  </div>
  
  <script>
    // Pagination configuration
    const ARTICLES_PER_PAGE = {{ articles_per_page }};
    const ENABLE_PAGINATION = {{ enable_pagination | default: true }};
    const TOTAL_ARTICLES = {{ total_articles }};
    const TOTAL_PAGES = Math.ceil(TOTAL_ARTICLES / ARTICLES_PER_PAGE);
    
    // Store last updated timestamp from Jekyll (if available)
    {% assign last_updated = site.data.news_last_updated.last_updated %}
    {% if last_updated %}
      const LAST_UPDATED_TIMESTAMP = {{ last_updated | jsonify }};
    {% else %}
      const LAST_UPDATED_TIMESTAMP = null;
    {% endif %}
    
    let currentPage = 1;
    let showAllMode = false;
    
    // Initialize pagination on page load
    function initializePage() {
      // Attach event listeners to buttons
      attachEventListeners();
      
      if (ENABLE_PAGINATION && TOTAL_ARTICLES > ARTICLES_PER_PAGE) {
        initializePagination();
      } else {
        // Show all articles if pagination is disabled or articles fit on one page
        showAllArticles();
      }
      
      // Always initialize Philippines time display (dynamically converts to PH time)
      updatePhilippinesTime();
      setInterval(updatePhilippinesTime, 60000); // Update every minute
    }
    
    // Attach event listeners to all buttons
    function attachEventListeners() {
      // Show All button
      const showAllBtn = document.getElementById('show-all-btn');
      if (showAllBtn) {
        showAllBtn.addEventListener('click', showAllArticles);
      }
      
      // Show Paginated button
      const showPaginatedBtn = document.getElementById('show-paginated-btn');
      if (showPaginatedBtn) {
        showPaginatedBtn.addEventListener('click', showPaginatedArticles);
      }
      
      // Previous button
      const prevBtn = document.getElementById('prev-btn');
      if (prevBtn) {
        prevBtn.addEventListener('click', () => changePage(-1));
      }
      
      // Next button
      const nextBtn = document.getElementById('next-btn');
      if (nextBtn) {
        nextBtn.addEventListener('click', () => changePage(1));
      }
    }
    
    // Run immediately if DOM is already loaded, otherwise wait for DOMContentLoaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializePage);
    } else {
      // DOM is already loaded
      initializePage();
    }
    
    function initializePagination() {
      showAllMode = false;
      updatePageNumbers();
      showPage(currentPage);
    }
    
    function showPage(page) {
      currentPage = Math.max(1, Math.min(page, TOTAL_PAGES));
      const startIndex = (currentPage - 1) * ARTICLES_PER_PAGE;
      const endIndex = startIndex + ARTICLES_PER_PAGE;
      
      const articles = document.querySelectorAll('.news-item');
      articles.forEach((article, index) => {
        if (index >= startIndex && index < endIndex) {
          article.style.display = 'block';
        } else {
          article.style.display = 'none';
        }
      });
      
      // Update pagination info
      document.getElementById('showing-from').textContent = startIndex + 1;
      document.getElementById('showing-to').textContent = Math.min(endIndex, TOTAL_ARTICLES);
      
      // Update button states
      document.getElementById('prev-btn').disabled = currentPage === 1;
      document.getElementById('next-btn').disabled = currentPage === TOTAL_PAGES;
      
      // Update page number buttons
      updatePageNumbers();
      
      // Scroll to top of news container
      document.getElementById('news-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function updatePageNumbers() {
      const pageNumbersDiv = document.getElementById('page-numbers');
      if (!pageNumbersDiv) return;
      
      pageNumbersDiv.innerHTML = '';
      
      // Show page numbers (max 7 visible at a time)
      let startPage = Math.max(1, currentPage - 3);
      let endPage = Math.min(TOTAL_PAGES, currentPage + 3);
      
      // Adjust if we're near the start or end
      if (endPage - startPage < 6) {
        if (startPage === 1) {
          endPage = Math.min(7, TOTAL_PAGES);
        } else if (endPage === TOTAL_PAGES) {
          startPage = Math.max(1, TOTAL_PAGES - 6);
        }
      }
      
      // First page
      if (startPage > 1) {
        const btn = createPageButton(1);
        pageNumbersDiv.appendChild(btn);
        if (startPage > 2) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0 5px';
          pageNumbersDiv.appendChild(ellipsis);
        }
      }
      
      // Page range
      for (let i = startPage; i <= endPage; i++) {
        const btn = createPageButton(i);
        pageNumbersDiv.appendChild(btn);
      }
      
      // Last page
      if (endPage < TOTAL_PAGES) {
        if (endPage < TOTAL_PAGES - 1) {
          const ellipsis = document.createElement('span');
          ellipsis.textContent = '...';
          ellipsis.style.padding = '0 5px';
          pageNumbersDiv.appendChild(ellipsis);
        }
        const btn = createPageButton(TOTAL_PAGES);
        pageNumbersDiv.appendChild(btn);
      }
    }
    
    function createPageButton(pageNum) {
      const btn = document.createElement('button');
      btn.textContent = pageNum;
      btn.onclick = () => showPage(pageNum);
      btn.style.padding = '8px 12px';
      btn.style.minWidth = '40px';
      btn.style.border = '1px solid var(--link-color)';
      btn.style.borderRadius = '4px';
      btn.style.cursor = 'pointer';
      btn.style.fontSize = '0.9em';
      
      if (pageNum === currentPage) {
        btn.style.backgroundColor = 'var(--link-color)';
        btn.style.color = 'white';
        btn.style.fontWeight = 'bold';
      } else {
        btn.style.backgroundColor = 'transparent';
        btn.style.color = 'var(--link-color)';
      }
      
      return btn;
    }
    
    function changePage(direction) {
      showPage(currentPage + direction);
    }
    
    function showAllArticles() {
      showAllMode = true;
      const articles = document.querySelectorAll('.news-item');
      articles.forEach(article => {
        article.style.display = 'block';
      });
      
      // Hide pagination controls
      const paginationControls = document.getElementById('pagination-controls');
      if (paginationControls) {
        paginationControls.style.display = 'none';
      }
      
      // Update button visibility
      const showAllBtn = document.getElementById('show-all-btn');
      const showPaginatedBtn = document.getElementById('show-paginated-btn');
      if (showAllBtn) showAllBtn.style.display = 'none';
      if (showPaginatedBtn) showPaginatedBtn.style.display = 'inline-block';
      
      // Scroll to top
      document.getElementById('news-container').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function showPaginatedArticles() {
      showAllMode = false;
      
      // Show pagination controls
      const paginationControls = document.getElementById('pagination-controls');
      if (paginationControls) {
        paginationControls.style.display = 'block';
      }
      
      // Update button visibility
      const showAllBtn = document.getElementById('show-all-btn');
      const showPaginatedBtn = document.getElementById('show-paginated-btn');
      if (showAllBtn) showAllBtn.style.display = 'inline-block';
      if (showPaginatedBtn) showPaginatedBtn.style.display = 'none';
      
      // Show current page
      showPage(currentPage);
    }
    
    // Display time in Philippines timezone (PHT - UTC+8) - dynamically formats timestamp in PH time
    function updatePhilippinesTime() {
      const timeElement = document.getElementById('philippines-time');
      if (!timeElement) {
        console.warn('philippines-time element not found');
        return;
      }
      
      // Debug: log the timestamp value
      if (typeof LAST_UPDATED_TIMESTAMP !== 'undefined') {
        console.log('LAST_UPDATED_TIMESTAMP:', LAST_UPDATED_TIMESTAMP, 'Type:', typeof LAST_UPDATED_TIMESTAMP);
      }
      
      // If we have a timestamp from the YAML file, parse and display it in PH time format
      if (LAST_UPDATED_TIMESTAMP && typeof LAST_UPDATED_TIMESTAMP === 'string' && LAST_UPDATED_TIMESTAMP.trim() !== '') {
        // Parse timestamp format: "2025-11-15 08:24:16 AM GMT +8" or "2025-11-15 12:47:02 PM GMT +8"
        const timestampStr = LAST_UPDATED_TIMESTAMP.replace(' GMT +8', '').trim();
        
        try {
          // Parse the timestamp (format: "YYYY-MM-DD HH:MM:SS AM/PM")
          const parts = timestampStr.match(/(\d{4}-\d{2}-\d{2})\s+(\d{1,2}):(\d{2}):(\d{2})\s+(AM|PM)/i);
          if (parts) {
            const datePart = parts[1];
            const hours = parts[2];
            const minutes = parts[3];
            const seconds = parts[4];
            const ampm = parts[5].toUpperCase();
            
            // Convert to 24-hour format for Date parsing
            let hour24 = parseInt(hours);
            if (ampm === 'PM' && hour24 !== 12) hour24 += 12;
            if (ampm === 'AM' && hour24 === 12) hour24 = 0;
            
            // Create date object treating the timestamp as PH time (UTC+8)
            // We'll create it as UTC and then format it in PH timezone
            const isoString = `${datePart}T${String(hour24).padStart(2, '0')}:${minutes}:${seconds}`;
            const dateObj = new Date(isoString);
            
            if (!isNaN(dateObj.getTime())) {
              // Format in Philippines timezone to ensure correct display
              const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit', 
                hour: 'numeric', 
                minute: '2-digit',
                second: '2-digit',
                hour12: true,
                timeZone: 'Asia/Manila'
              };
              
              const formatted = dateObj.toLocaleString('en-US', options);
              // Convert from "MM/DD/YYYY, HH:MM:SS AM/PM" to "YYYY-MM-DD HH:MM:SS AM/PM GMT +8"
              const dateParts = formatted.split(', ');
              if (dateParts.length === 2) {
                const [datePartFormatted, timePart] = dateParts;
                const [month, day, year] = datePartFormatted.split('/');
                timeElement.textContent = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${timePart} GMT +8`;
                return; // Success, exit early
              }
            }
          }
          // If we get here, parsing failed - use original timestamp
          timeElement.textContent = LAST_UPDATED_TIMESTAMP;
        } catch (e) {
          // If parsing fails, display original timestamp
          console.warn('Error parsing timestamp:', e);
          timeElement.textContent = LAST_UPDATED_TIMESTAMP;
        }
      } else {
        // No timestamp available, show current PH time
        const now = new Date();
        const options = { 
          year: 'numeric', 
          month: '2-digit', 
          day: '2-digit', 
          hour: 'numeric', 
          minute: '2-digit',
          second: '2-digit',
          hour12: true,
          timeZone: 'Asia/Manila'
        };
        const formatted = now.toLocaleString('en-US', options);
        const dateParts = formatted.split(', ');
        if (dateParts.length === 2) {
          const [datePart, timePart] = dateParts;
          const [month, day, year] = datePart.split('/');
          timeElement.textContent = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${timePart} GMT +8`;
        } else {
          timeElement.textContent = formatted;
        }
      }
    }
  </script>
{% else %}
  <p>No news items available at this time. Please check back later.</p>
{% endif %}
