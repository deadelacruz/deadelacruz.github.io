{% comment %} Extract topic from page permalink {% endcomment %}
{% assign topic = page.permalink | remove: '/' | replace: '-', '_' %}
{% assign news_data = null %}

{% comment %} Map topic to corresponding data file {% endcomment %}
{% case topic %}
  {% when 'deep_learning' %}
    {% assign news_data = site.data.news.deep-learning %}
  {% when 'machine_learning' %}
    {% assign news_data = site.data.news.machine-learning %}
  {% when 'artificial_intelligence' %}
    {% assign news_data = site.data.news.artificial-intelligence %}
  {% when 'technology' %}
    {% assign news_data = site.data.news.technology %}
  {% when 'science' %}
    {% assign news_data = site.data.news.science %}
  {% when 'business' %}
    {% assign news_data = site.data.news.business %}
  {% when 'health' %}
    {% assign news_data = site.data.news.health %}
{% endcase %}

{% if news_data and news_data.news_items %}
  {% assign sorted_news = news_data.news_items | sort: "date" | reverse %}
  {% assign total_articles = sorted_news | size %}
  
  <div class="news-container-wrapper">
    {% comment %} News items container - all articles displayed at once {% endcomment %}
    <div id="news-container" class="news-container">
      {% for item in sorted_news %}
        <div class="news-item" data-article-index="{{ forloop.index0 }}" style="margin-bottom: 20px; padding: 15px; background-color: var(--card-background-color); border-radius: 8px; border-left: 4px solid var(--link-color);">
          <h4 style="margin-top: 0; margin-bottom: 10px;">
            <strong>{{ item.title | escape }}</strong>
          </h4>
          <p style="margin-bottom: 10px; color: var(--main-text-color);">
            {{ item.description | escape }}
          </p>
          <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" style="color: var(--link-color); text-decoration: none;">
            Read more â†’
          </a>
          {% if item.source %}
            <span style="color: var(--main-text-color); opacity: 0.7; font-size: 0.9em; margin-left: 10px;">
              | {{ item.source | escape }}
            </span>
          {% endif %}
          {% if item.date %}
            <span style="color: var(--main-text-color); opacity: 0.7; font-size: 0.9em; margin-left: 10px;">
              {% comment %} Format date - Jekyll date filter handles YYYY-MM-DD format {% endcomment %}
              {% assign formatted_date = item.date | date: "%B %d, %Y" %}
              {% if formatted_date != item.date %}
                ({{ formatted_date }})
              {% else %}
                ({{ item.date }})
              {% endif %}
            </span>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    
    <p style="margin-top: 20px; font-style: italic; color: var(--main-text-color); opacity: 0.7;">
      <em>Last updated: 
        {% assign last_updated = site.data.news_last_updated.last_updated %}
        {% if last_updated %}
          <span id="philippines-time">{{ last_updated }}</span>
        {% else %}
          <span id="philippines-time">Loading...</span>
        {% endif %}
      </em>
    </p>
  </div>
  
  <script>
    // Display time in Philippines timezone (PHT - UTC+8) - fallback only if Jekyll didn't render it
    function updatePhilippinesTime() {
      const timeElement = document.getElementById('philippines-time');
      if (!timeElement) {
        return;
      }
      
      // Only update if it still says "Loading..." (meaning Jekyll didn't render the timestamp)
      if (timeElement.textContent.trim() === 'Loading...') {
        // No timestamp available from Jekyll, show current PH time
        try {
          const now = new Date();
          const options = { 
            year: 'numeric', 
            month: '2-digit', 
            day: '2-digit', 
            hour: 'numeric', 
            minute: '2-digit',
            second: '2-digit',
            hour12: true,
            timeZone: 'Asia/Manila'
          };
          const formatted = now.toLocaleString('en-US', options);
          const dateParts = formatted.split(', ');
          if (dateParts.length === 2) {
            const [datePart, timePart] = dateParts;
            const [month, day, year] = datePart.split('/');
            timeElement.textContent = `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')} ${timePart} GMT +8`;
          } else {
            timeElement.textContent = formatted + ' GMT +8';
          }
        } catch (e) {
          // Fallback if time formatting fails
          timeElement.textContent = new Date().toLocaleString('en-US', { timeZone: 'Asia/Manila' }) + ' GMT +8';
        }
      }
      // If timestamp is already displayed (from Jekyll), do nothing
    }
    
    // Initialize Philippines time display on page load
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', updatePhilippinesTime);
    } else {
      updatePhilippinesTime();
    }
  </script>
{% else %}
  <p>No news items available at this time. Please check back later.</p>
{% endif %}
