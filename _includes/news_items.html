{% comment %} Extract topic from page permalink {% endcomment %}
{% assign topic = page.permalink | remove: '/' | replace: '-', '_' %}
{% assign news_data = null %}

{% comment %} Map topic to corresponding data file {% endcomment %}
{% case topic %}
  {% when 'deep_learning' %}
    {% assign news_data = site.data.news.deep-learning %}
  {% when 'machine_learning' %}
    {% assign news_data = site.data.news.machine-learning %}
  {% when 'artificial_intelligence' %}
    {% assign news_data = site.data.news.artificial-intelligence %}
  {% when 'technology' %}
    {% assign news_data = site.data.news.technology %}
  {% when 'science' %}
    {% assign news_data = site.data.news.science %}
  {% when 'business' %}
    {% assign news_data = site.data.news.business %}
  {% when 'health' %}
    {% assign news_data = site.data.news.health %}
{% endcase %}

{% if news_data and news_data.news_items %}
  {% assign sorted_news = news_data.news_items | sort: "date" | reverse %}
  {% assign total_articles = sorted_news | size %}
  {% assign initial_articles_per_page = site.data.news_config.ui.articles_per_page | default: 10 %}
  {% assign articles_per_page_limit = initial_articles_per_page | plus: 0 %}
  {% assign initial_display_count = initial_articles_per_page %}
  {% if total_articles < articles_per_page_limit %}
    {% assign initial_display_count = total_articles %}
  {% endif %}
  {% assign section_id = topic | default: 'news' %}
  {% assign section_id = section_id | replace: '/', '_' %}
  {% assign section_id = section_id | replace: '-', '_' %}
  {% assign news_container_id = 'news-container-' | append: section_id %}
  {% assign pagination_controls_id = 'pagination-controls-' | append: section_id %}
  {% assign pagination_buttons_id = 'pagination-buttons-' | append: section_id %}
  {% assign prev_btn_id = 'prev-btn-' | append: section_id %}
  {% assign next_btn_id = 'next-btn-' | append: section_id %}
  {% assign pagination_info_id = 'pagination-info-' | append: section_id %}
  {% assign total_pages = total_articles | divided_by: articles_per_page_limit %}
  {% if total_articles | modulo: articles_per_page_limit != 0 %}
    {% assign total_pages = total_pages | plus: 1 %}
  {% endif %}
  
  <style>
    .pagination-btn:hover:not(:disabled) {
      opacity: 0.8;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .page-number-btn:hover {
      opacity: 0.8;
      transform: translateY(-1px);
      transition: all 0.2s ease;
    }
  </style>
  
  <div class="news-container-wrapper">
    {% comment %} News items container grouped per page - JS toggles pages {% endcomment %}
    <div id="{{ news_container_id }}" class="news-container">
      {% assign total_pages_minus_one = total_pages | minus: 1 %}
      {% for page_index in (0..total_pages_minus_one) %}
        {% assign page_offset = page_index | times: articles_per_page_limit %}
        {% assign page_number = page_index | plus: 1 %}
        <div class="news-page" data-page="{{ page_number }}" {% unless page_number == 1 %}style="display: none;"{% endunless %}>
          {% for item in sorted_news limit:articles_per_page_limit offset:page_offset %}
            <div class="news-item" data-article-index="{{ forloop.index0 | plus: page_offset }}" style="margin-bottom: 20px; padding: 15px; background-color: var(--card-background-color); border-radius: 8px; border-left: 4px solid var(--link-color);">
              <h4 style="margin-top: 0; margin-bottom: 10px;">
                <strong>{{ item.title | escape }}</strong>
              </h4>
              <p style="margin-bottom: 10px; color: var(--main-text-color);">
                {{ item.description | escape }}
              </p>
              <a href="{{ item.url }}" target="_blank" rel="noopener noreferrer" style="color: var(--link-color); text-decoration: none;">
                Read more â†’
              </a>
              {% if item.source %}
                <span style="color: var(--main-text-color); opacity: 0.7; font-size: 0.9em; margin-left: 10px;">
                  | {{ item.source | escape }}
                </span>
              {% endif %}
              {% if item.date %}
                <span style="color: var(--main-text-color); opacity: 0.7; font-size: 0.9em; margin-left: 10px;">
                  {% assign formatted_date = item.date | date: "%B %d, %Y" %}
                  {% if formatted_date != item.date %}
                    ({{ formatted_date }})
                  {% else %}
                    ({{ item.date }})
                  {% endif %}
                </span>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% endfor %}
    </div>
    
    {% comment %} Pagination Controls {% endcomment %}
    {% assign enable_pagination = site.data.news_config.ui.enable_pagination %}
    {% if enable_pagination %}
      <div id="{{ pagination_controls_id }}" style="margin-top: 30px; margin-bottom: 20px; text-align: center;">
        <div id="{{ pagination_buttons_id }}" style="display: flex; justify-content: center; align-items: center; gap: 10px; flex-wrap: wrap;">
          <button id="{{ prev_btn_id }}" class="pagination-btn" style="padding: 8px 16px; background-color: var(--link-color, #ca6521); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;" disabled>Previous</button>
          <button id="{{ next_btn_id }}" class="pagination-btn" style="padding: 8px 16px; background-color: var(--link-color, #ca6521); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 14px;">Next</button>
        </div>
        <div id="{{ pagination_info_id }}" style="margin-top: 15px; color: var(--main-text-color); opacity: 0.7; font-size: 0.9em;">
          Showing 1-{{ initial_display_count }} of {{ total_articles }} articles
        </div>
      </div>
    {% endif %}
    
    <p style="margin-top: 20px; font-style: italic; color: var(--main-text-color); opacity: 0.7;">
      <em>Last updated: 
        {% assign last_updated = site.data.news_last_updated.last_updated %}
        {% if last_updated %}
          <span id="philippines-time">{{ last_updated }}</span>
        {% else %}
          <span id="philippines-time">Loading...</span>
        {% endif %}
      </em>
    </p>
  </div>
  
  <script>
    {% assign enable_pagination = site.data.news_config.ui.enable_pagination %}
    {% if enable_pagination %}
    /* Pagination functionality - ensure DOM is ready */
    (function() {
      function initPagination() {
        const newsContainer = document.getElementById('{{ news_container_id }}');
        if (!newsContainer) {
          console.warn('News container not found');
          return;
        }

        const totalArticles = {{ total_articles }};
        const articlesPerPageSetting = Math.max({{ articles_per_page_limit }}, 1);
        const pages = Array.from(newsContainer.querySelectorAll('.news-page'));
        const totalPages = pages.length || Math.max(1, Math.ceil(totalArticles / articlesPerPageSetting));
        console.log('[News Pagination] init', {
          container: '{{ news_container_id }}',
          totalArticles,
          articlesPerPageSetting,
          totalPages,
          pagesFound: pages.length
        });

        if (totalArticles === 0 || pages.length === 0) return;

        let currentPage = 1;
        const articlesPerPage = articlesPerPageSetting;

        const paginationControls = document.getElementById('{{ pagination_controls_id }}');
        const prevBtn = document.getElementById('{{ prev_btn_id }}');
        const nextBtn = document.getElementById('{{ next_btn_id }}');
        const paginationInfo = document.getElementById('{{ pagination_info_id }}');
        const paginationButtonsWrapper = document.getElementById('{{ pagination_buttons_id }}');

        if (!prevBtn || !nextBtn || !paginationInfo) {
          console.warn('Pagination controls not found');
          return;
        }

        function renderPage() {
          const newTotalPages = totalPages;

          prevBtn.disabled = currentPage === 1;
          nextBtn.disabled = currentPage >= newTotalPages;

          const displayStart = (currentPage - 1) * articlesPerPage + 1;
          const displayEnd = Math.min(currentPage * articlesPerPage, totalArticles);
          paginationInfo.textContent = `Showing ${displayStart}-${displayEnd} of ${totalArticles} articles`;

          pages.forEach((pageEl, index) => {
            pageEl.style.display = (index === currentPage - 1) ? '' : 'none';
          });
        }

        function goToPage(page) {
          currentPage = page;
          renderPage();
          const containerTop = newsContainer.getBoundingClientRect().top + window.pageYOffset - 20;
          window.scrollTo({ top: Math.max(containerTop, 0), behavior: 'smooth' });
          console.log('[News Pagination] goToPage -> page', page);
        }

        prevBtn.addEventListener('click', () => {
          if (currentPage > 1) {
            goToPage(currentPage - 1);
          } else {
            console.log('[News Pagination] Prev click ignored on first page');
          }
        });

        nextBtn.addEventListener('click', () => {
          const newTotalPages = totalPages;
          if (currentPage < newTotalPages) {
            goToPage(currentPage + 1);
          } else {
            console.log('[News Pagination] Next click ignored on last page');
          }
        });

        renderPage();
        if (totalPages <= 1) {
          if (paginationButtonsWrapper) {
            paginationButtonsWrapper.style.display = 'none';
          }
          nextBtn.disabled = true;
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initPagination);
      } else {
        initPagination();
      }
    })();
    {% endif %}
    
  </script>
  
{% else %}
  <p>No news items available at this time. Please check back later.</p>
{% endif %}
